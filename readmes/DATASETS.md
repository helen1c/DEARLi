# Prepare Datasets for Mask2Former

A dataset can be used by accessing [DatasetCatalog](https://detectron2.readthedocs.io/modules/data.html#detectron2.data.DatasetCatalog)
for its data, or [MetadataCatalog](https://detectron2.readthedocs.io/modules/data.html#detectron2.data.MetadataCatalog) for its metadata (class names, etc).
This document explains how to setup the builtin datasets so they can be used by the above APIs.

MaskFormer has builtin support for a few datasets.
The datasets are assumed to exist in a directory specified by the environment variable
`DETECTRON2_DATASETS`.
Under this directory, detectron2 will look for datasets in the structure described below, if needed.

```
$DETECTRON2_DATASETS/
  ADEChallengeData2016/
  coco/
```

You can set the location for builtin datasets by:
```bash
export DETECTRON2_DATASETS=/path/to/datasets
```

If left unset, the default is `./datasets` relative to your current working directory.

The [model zoo](https://github.com/facebookresearch/MaskFormer/blob/master/MODEL_ZOO.md)
contains configs and models that use these builtin datasets.


---

## Expected dataset structure for [COCO Panoptic](https://cocodataset.org/#download):

```
coco/
  annotations/
    instances_{train,val}2017.json
    panoptic_{train,val}2017.json
  {train,val}2017/
    # image files mentioned in the corresponding json
  panoptic_{train,val}2017/              # png annotations
  panoptic_semseg_{train,val}2017/       # generated by the script mentioned below
```

Install panopticapi:
```bash
pip install git+https://github.com/cocodataset/panopticapi.git
```

Then, run:
```bash
python datasets/prepare_coco_semantic_annos_from_panoptic_annos.py
```
to extract semantic annotations from panoptic annotations (used for evaluation only).

### TODO Coco-objects

## Expected dataset structure for [ADE20K (ADEChallengeData2016)](http://sceneparsing.csail.mit.edu/):

```
ADEChallengeData2016/
  images/
  annotations/
  objectInfo150.txt
  # download instance annotations
  annotations_instance/
  # generated by prepare_ade20k_sem_seg.py
  annotations_detectron2/
  # generated by prepare_ade20k_pan_seg.py
  ade20k_panoptic_{train,val}.json
  ade20k_panoptic_{train,val}/
  # generated by prepare_ade20k_ins_seg.py
  ade20k_instance_{train,val}.json
```

The directory `annotations_detectron2` is generated by running:
```bash
python datasets/prepare_ade20k_sem_seg.py
```

Install panopticapi:
```bash
pip install git+https://github.com/cocodataset/panopticapi.git
```

Download the instance annotation from:
```bash
wget http://sceneparsing.csail.mit.edu/data/ChallengeData2017/annotations_instance.tar
```

Then, run:
```bash
python datasets/prepare_ade20k_pan_seg.py
```
to combine semantic and instance annotations for panoptic annotations.

And run:
```bash
python datasets/prepare_ade20k_ins_seg.py
```
to extract instance annotations in COCO format.

---
#### DISCLAIMER: Adopted from [Mask2Former repository](https://github.com/facebookresearch/Mask2Former/blob/main/datasets/README.md).